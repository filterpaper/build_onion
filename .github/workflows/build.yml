name: Build Onion
on:
  workflow_dispatch:

jobs:
  build:
    name: Build Onion
    runs-on: ubuntu-latest
    container:
      image: aemiii91/miyoomini-toolchain:latest
      options: --user root
    env:
      REPOSITORY: "OnionUI/Onion"
      BRANCH: "main"

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        repository: ${{ env.REPOSITORY }}
        ref: ${{ env.BRANCH }}
        fetch-depth: 0
        submodules: recursive

    - name: Configure git
      run: git config --global --add safe.directory /__w/Onion/Onion

    - name: Setup variables
      run: |
        echo "BUILD_VERSION=$(make version)" >> $GITHUB_ENV
        echo "ONION_VERSION=$(make version)" >> $GITHUB_ENV
        #echo "ONION_VERSION=$(make version)-$(TZ=UTC date +%Y%m%d)" >> $GITHUB_ENV

    - name: Configure emulator defaults
      run: |
        echo "1600" > static/configs/RetroArch/cpuclock.txt
        sed -i 's/cpuclock 1500/cpuclock 1600/g' static/packages/Emu/Nintendo\ -\ DS\ \(Drastic\)/Emu/NDS/launch.sh
        sed -i 's/"theme":0,/"theme":7,/g' static/packages/Emu/Nintendo\ -\ DS\ \(Drastic\)/Emu/NDS/resources/settings.json
        sed -i 's/quick_menu_show_cheats = "false"/quick_menu_show_cheats = "true"/g' static/configs/RetroArch/.retroarch/retroarch.cfg
        sed -i 's/apply_cheats_after_load = "false"/apply_cheats_after_load = "true"/g' static/configs/RetroArch/.retroarch/retroarch.cfg
        sed -i 's/apply_cheats_after_toggle = "false"/apply_cheats_after_toggle = "true"/g' static/configs/RetroArch/.retroarch/retroarch.cfg
        sed -i 's/pcsx_rearmed_dithering = "disabled"/pcsx_rearmed_dithering = "enabled"/g' static/configs/Saves/CurrentProfile/config/PCSX-ReARMed/PCSX-ReARMed.opt
        sed -i 's/gpsp_color_correction = "disabled"/gpsp_color_correction = "enabled"/g' static/configs/Saves/CurrentProfile/config/gpSP/gpSP.opt
        echo 'video_filter = ":/.retroarch/filters/video/Normal/Normal2x.filt"' >> static/configs/Saves/CurrentProfile/config/gpSP/gpSP.cfg
        echo 'video_filter = ":/.retroarch/filters/video/Upscale/Scale2x.filt"' >> static/configs/Saves/CurrentProfile/config/Supafaust/Supafaust.cfg
        echo 'video_scale_integer = "true"' >> static/configs/Saves/CurrentProfile/config/Supafaust/Supafaust.cfg

    - name: Build Onion-v${{ env.ONION_VERSION }}
      shell: bash
      run: |
        source /root/.bashrc
        VERSION_OVERRIDE=${{ env.ONION_VERSION }} make release

    - name: Upload release
      uses: actions/upload-artifact@main
      with:
        retention-days: 1
        name: Onion-v${{ env.ONION_VERSION }}
        path: release/Onion-v${{ env.ONION_VERSION }}.zip

  release:
    needs: build
    uses: filterpaper/scripts/.github/workflows/publish-artifact.yml@main
    with:
      release_name: OnionOS
      release_tag: latest

  purge:
    uses: filterpaper/scripts/.github/workflows/purge-workflow.yml@main
    with:
      purge-age: 3
      delete-all-completed: false
      delete-all-incomplete: false
